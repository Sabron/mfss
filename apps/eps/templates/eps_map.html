{% extends "subsystem_eps.html" %}
{% load static %}
{% load mysettings %}


{% block header_link %}
<link type="text/css" rel="stylesheet" href="{% static '/css/speedometer.css' %}?ver={% settings_value 'APP_VER' %}">
{% endblock header_link %}

{% block info_title %}
<h5>
    Система определения местоположения сотрудников фабрики <h5>
    {% endblock info_title %}

    {% block content %}
    <section class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <p id="id_time"></p>
            </div>
        </div><!-- /.container-fluid -->
    </section>

    <section class="content">
        <div class="container-fluid">
            <div class="card card-primary card-outline direct-chat">
                <div class="card-header">
                    <!--<div class="card-tools">
                        <button type="button" class="btn btn-tool" id="#optionsZone" onclick="edit_zone(this.id); return false">
                            <i class="fa-sharp fa-solid fa-screwdriver-wrench" style="color: blue;"></i> Добавить опасную зону
                        </button>
                        <button type="button" class="btn btn-tool" id="#personsOnMap" onclick="persons(this.id); return false">
                            <i class="fa-solid fa-users" style="color: blue;"></i> Персонал
                        </button>
                        <button type="button" class="btn btn-tool" id="#zoneOnMap" onclick="persons(this.id); return false">
                            <i class="fa-sharp fa-solid fa-triangle-exclamation" style="color: red;"></i> Опасные зоны
                        </button>
                    </div>-->
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-12 col-md-12 col-lg-12 order-2 order-md-1" style="padding: 10px 25px 15px">
                            <div class="d-md-flex">
                                <div class="p-1 flex-fill" style="overflow: hidden">
                                    <canvas id="canvas" style="border: 1px solid black"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    {% endblock %}
    {% block script_footer %}
    <script src="https://rawgit.com/kangax/fabric.js/master/dist/fabric.js"></script>

    <script>
     var canvas = new fabric.Canvas("canvas",{
        selection: false,
		scale: 1,
		moveCursor: 'default',
		hoverCursor: 'default'
    });

    fabric.Object.prototype.selectable = false;
    const img = new Image();

    img.onload = function() {
      canvas.setHeight(this.height);
      canvas.setWidth(this.width);
    }

    img.src = '{% static 'img/plan/otm_102.png' %}';
    img.crossOrigin = "Anonymous";
    canvas.setBackgroundImage(img.src, canvas.renderAll.bind(canvas));

    var all_marker = new Array();
    var all_marker_label = new Array();
    var marker;

    var addMarker = function(options) {
        marker = new fabric.Path(options.skin,
        {
            angle: 180,
            width: 20,
            height: 40,
            scaleX: 0.4,
            scaleY: 0.4,
            left: options.x,
            top: options.y,
            originX: 'center',
            originY: 'center',
            fill: options.color,
            stroke: 'black',
            text: options.name
        });

	    textObject = new fabric.Text(options.name, {
	        fontFamily: 'Arial',
            fontSize: 25,
            originX: 'center',
            fill: options.color,
            originY: 'center'
	    });

        // Обёртка вокруг текста
        background = new fabric.Rect({
            width: (options.name.length) * 14,
            height: 30,
            originX: 'center',
            originY: 'center',
            fill: 'white',
            stroke: 'black'
        });

        textGroup_marker = new fabric.Group([background, textObject], {
            scaleX: 0.5,
            scaleY: 0.5,
            left: options.x + 30 * 0.5, // необходимо учитывать масштаб
            top: options.y - 20 * 0.5 // необходимо учитывать масштаб
        });

        var send_marker = all_marker.push(marker);
        var send_textGroup = all_marker_label.push(textGroup_marker);

        canvas.add(marker);
        canvas.add(textGroup_marker);
    };

    var addAnchors = function(options) {
        var anchors = new fabric.Path(options.skin,
        {
            width: 20,
            height: 40,
            scaleX: 0.015,
            scaleY: 0.015,
            left: options.x,
            top: options.y,
            originX: 'center',
            originY: 'center',
            fill: options.color,
            text: options.name // сохраним текст в объекте для импорта/экспорта
        });

        textObject = new fabric.Text(options.name, {
            fontWeight: 'bold',
            fontFamily: 'Arial',
            fontSize: 20,
            originX: 'center',
            fill: options.color,
            originY: 'center'
	    });

        // Обёртка вокруг текста
        background = new fabric.Rect({
            width: (options.name.length+2) * 14,
            height: 30,
            originX: 'center',
            originY: 'center',
            fill: 'white',
            stroke: 'black'
        });

        textGroup_anchors = new fabric.Group([background, textObject], {
            scaleX: 0.5,
            scaleY: 0.5,
            left: options.x - 35 * 0.5, // необходимо учитывать масштаб
            top: options.y - 50 * 0.5 // необходимо учитывать масштаб
        });

        canvas.add(textGroup_anchors);
        canvas.add(anchors);
    };

        /*{% for tag in tag_list %}
            addMarker({x: {{tag.x}}, {{tag.y}}: 0, name: {{tag.name}}, color: '#006400', skin: 'm 11,-19.124715 c -8.2234742,0 -14.8981027,-6.676138 -14.8981027,-14.9016 0,-5.633585 3.35732837,-10.582599 6.3104192,-14.933175 C 4.5507896,-52.109948 9.1631953,-59.34619 11,-61.92345 c 1.733396,2.518329 6.760904,9.975806 8.874266,13.22971 3.050966,4.697513 6.023837,8.647788 6.023837,14.667425 0,8.225462 -6.674629,14.9016 -14.898103,14.9016 z m 0,-9.996913 c 2.703016,0 4.903568,-2.201022 4.903568,-4.904687 0,-2.703664 -2.200552,-4.873493 -4.903568,-4.873493 -2.7030165,0 -4.903568,2.169829 -4.903568,4.873493 0,2.703665 2.2005515,4.904687 4.903568,4.904687z'});
        {% endfor %}
        */
    //addMarker({x: 0, y: 0, name: 'Мамедов А.А.', color: '#006400', skin: 'm 11,-19.124715 c -8.2234742,0 -14.8981027,-6.676138 -14.8981027,-14.9016 0,-5.633585 3.35732837,-10.582599 6.3104192,-14.933175 C 4.5507896,-52.109948 9.1631953,-59.34619 11,-61.92345 c 1.733396,2.518329 6.760904,9.975806 8.874266,13.22971 3.050966,4.697513 6.023837,8.647788 6.023837,14.667425 0,8.225462 -6.674629,14.9016 -14.898103,14.9016 z m 0,-9.996913 c 2.703016,0 4.903568,-2.201022 4.903568,-4.904687 0,-2.703664 -2.200552,-4.873493 -4.903568,-4.873493 -2.7030165,0 -4.903568,2.169829 -4.903568,4.873493 0,2.703665 2.2005515,4.904687 4.903568,4.904687z'});
    //addMarker({x: 0, y: 0, name: 'Мамедов А.А.1', color: '#006400', skin: 'm 11,-19.124715 c -8.2234742,0 -14.8981027,-6.676138 -14.8981027,-14.9016 0,-5.633585 3.35732837,-10.582599 6.3104192,-14.933175 C 4.5507896,-52.109948 9.1631953,-59.34619 11,-61.92345 c 1.733396,2.518329 6.760904,9.975806 8.874266,13.22971 3.050966,4.697513 6.023837,8.647788 6.023837,14.667425 0,8.225462 -6.674629,14.9016 -14.898103,14.9016 z m 0,-9.996913 c 2.703016,0 4.903568,-2.201022 4.903568,-4.904687 0,-2.703664 -2.200552,-4.873493 -4.903568,-4.873493 -2.7030165,0 -4.903568,2.169829 -4.903568,4.873493 0,2.703665 2.2005515,4.904687 4.903568,4.904687z'});
	//addAnchors({x: 400, y: 300, name: 'A21', color: '#0000FF', skin: 'M10,678.3c0.9-4.6,1.5-9.3,2.7-13.8c9.5-38.2,41.7-62.4,83.2-62.4c152.1,0,304.3,0,456.4,0c2.9,0,5.7,0,9.3,0c0-2.9,0-5.2,0-7.6c0-68,0-136.1,0-204.1c0-22.1,9.4-38.5,29.2-48.6c29.5-15,67.9,5.6,71.6,38.5c0.6,5.2,0.9,10.5,0.9,15.8c0.1,66.2,0,132.4,0,198.7c0,2.2,0,4.3,0,7.3c2.7,0,4.9,0,7.2,0c77.9,0,155.8,0,233.7,0c19.9,0,38.3,4.8,54.1,17.3c19.3,15.3,30.7,35.4,31.1,60.1c0.7,43.8,0.4,87.6,0.4,131.3c0,34.1,0.4,68.2-0.3,102.3c-0.8,38.7-33.7,72.7-72.2,76.1c-2.2,0.2-4.3,0.7-6.4,1c-274,0-548,0-822.1,0c-1.4-0.3-2.8-0.8-4.2-0.9c-36.6-3.4-65.5-29.5-72.7-65.7c-0.7-3.3-1.2-6.7-1.9-10.1C10,835.2,10,756.7,10,678.3z M163.2,847c28,0.1,51.4-23.2,51.3-51.1c-0.1-27.8-23-50.8-50.9-51c-28-0.3-51.1,22.6-51.5,50.8C111.7,823.4,135.1,847,163.2,847z M346.3,847c28,0.5,50.9-21.6,51.9-50.4c1-27.2-22.1-51-50.1-51.7c-28.1-0.7-52.1,22.2-52.1,50.7C296,824.2,317.9,846.3,346.3,847z, M606.5,9.8c116.5,2.2,210,42.6,284.9,123.7c49.6,53.6,80.3,117.1,92.9,189.2c3.9,22.5,6.3,45.2,5.3,68c-1.2,26.1-21.5,45.8-48.1,47.7c-23.8,1.7-47.5-16.2-51.9-40.4c-2-10.9-1.5-22.2-2.4-33.2c-4.2-52.2-21.9-99.5-53.2-141.3c-42.5-56.8-98.8-92.8-168.5-106.3c-137.3-26.6-270.2,51.4-314.8,184.1c-8.4,25-12.9,50.8-13.6,77.2c-0.3,12.1-0.8,24.1-7.4,34.8c-10.9,17.5-26.8,26.3-47.2,24.9c-21.8-1.6-36.9-13.4-44.5-34.1c-5.1-13.8-2.9-28.2-2-42.3c3-46.3,14.2-90.6,33.9-132.6c32.9-70.2,82.5-125.3,148.8-165.4C461,38,507,21.5,556,14.4C574.8,11.7,593.8,10.9,606.5,9.8z, M608.8,172.8c86.6,3.8,150.2,40.1,191.6,112.5c17.8,31,26,65.2,26.1,101c0.1,40.9-41.8,65.1-77.1,44.5c-16.8-9.8-24.1-25.6-24.6-44.8c-0.6-25.2-8.7-47.7-24-67.8c-40.8-53.6-124.4-57.5-170-7.9c-19.4,21.1-29.9,45.8-30.7,74.6c-0.5,19.7-7.6,36.2-25.2,46.2c-35.4,20.1-76.8-3.9-76.5-44.7c0.3-53.1,18.2-99.9,53.2-139.9c31-35.5,69.8-58.1,115.7-68C582.1,175.2,597.3,174.3,608.8,172.8z'});
	//addAnchors({x: 340, y: 200, name: 'A22', color: '#0000FF', skin: 'M10,678.3c0.9-4.6,1.5-9.3,2.7-13.8c9.5-38.2,41.7-62.4,83.2-62.4c152.1,0,304.3,0,456.4,0c2.9,0,5.7,0,9.3,0c0-2.9,0-5.2,0-7.6c0-68,0-136.1,0-204.1c0-22.1,9.4-38.5,29.2-48.6c29.5-15,67.9,5.6,71.6,38.5c0.6,5.2,0.9,10.5,0.9,15.8c0.1,66.2,0,132.4,0,198.7c0,2.2,0,4.3,0,7.3c2.7,0,4.9,0,7.2,0c77.9,0,155.8,0,233.7,0c19.9,0,38.3,4.8,54.1,17.3c19.3,15.3,30.7,35.4,31.1,60.1c0.7,43.8,0.4,87.6,0.4,131.3c0,34.1,0.4,68.2-0.3,102.3c-0.8,38.7-33.7,72.7-72.2,76.1c-2.2,0.2-4.3,0.7-6.4,1c-274,0-548,0-822.1,0c-1.4-0.3-2.8-0.8-4.2-0.9c-36.6-3.4-65.5-29.5-72.7-65.7c-0.7-3.3-1.2-6.7-1.9-10.1C10,835.2,10,756.7,10,678.3z M163.2,847c28,0.1,51.4-23.2,51.3-51.1c-0.1-27.8-23-50.8-50.9-51c-28-0.3-51.1,22.6-51.5,50.8C111.7,823.4,135.1,847,163.2,847z M346.3,847c28,0.5,50.9-21.6,51.9-50.4c1-27.2-22.1-51-50.1-51.7c-28.1-0.7-52.1,22.2-52.1,50.7C296,824.2,317.9,846.3,346.3,847z, M606.5,9.8c116.5,2.2,210,42.6,284.9,123.7c49.6,53.6,80.3,117.1,92.9,189.2c3.9,22.5,6.3,45.2,5.3,68c-1.2,26.1-21.5,45.8-48.1,47.7c-23.8,1.7-47.5-16.2-51.9-40.4c-2-10.9-1.5-22.2-2.4-33.2c-4.2-52.2-21.9-99.5-53.2-141.3c-42.5-56.8-98.8-92.8-168.5-106.3c-137.3-26.6-270.2,51.4-314.8,184.1c-8.4,25-12.9,50.8-13.6,77.2c-0.3,12.1-0.8,24.1-7.4,34.8c-10.9,17.5-26.8,26.3-47.2,24.9c-21.8-1.6-36.9-13.4-44.5-34.1c-5.1-13.8-2.9-28.2-2-42.3c3-46.3,14.2-90.6,33.9-132.6c32.9-70.2,82.5-125.3,148.8-165.4C461,38,507,21.5,556,14.4C574.8,11.7,593.8,10.9,606.5,9.8z, M608.8,172.8c86.6,3.8,150.2,40.1,191.6,112.5c17.8,31,26,65.2,26.1,101c0.1,40.9-41.8,65.1-77.1,44.5c-16.8-9.8-24.1-25.6-24.6-44.8c-0.6-25.2-8.7-47.7-24-67.8c-40.8-53.6-124.4-57.5-170-7.9c-19.4,21.1-29.9,45.8-30.7,74.6c-0.5,19.7-7.6,36.2-25.2,46.2c-35.4,20.1-76.8-3.9-76.5-44.7c0.3-53.1,18.2-99.9,53.2-139.9c31-35.5,69.8-58.1,115.7-68C582.1,175.2,597.3,174.3,608.8,172.8z'});

    var pointMode = false;
	var x;

	function makeZone() {
        pointMode = true;
        document.getElementById("#zoneOnMap").disabled = true;
        document.getElementById("#personsOnMap").disabled = true;
        document.getElementById("#optionsZone").disabled = true;
    };

    function finishMake() {
        pointMode = false;
        document.getElementById("#zoneOnMap").disabled = false;
        document.getElementById("#personsOnMap").disabled = false;
        document.getElementById("#optionsZone").disabled = false;
    };

    var all_points = new Array();

    canvas.on('mouse:down', function(options) {
        pointsWarningZone(options.e);
    });

    var pointsWarningZone = function(mouseEvent){
        var click_points = canvas.getPointer(mouseEvent);

        if(pointMode){

            x = document.getElementById("color_zone").value;

            var converterPointsJSON = function(points) {
                return{ x: points.x, y: points.y };
            };

            var total = all_points.push(converterPointsJSON(click_points));
            circle = new fabric.Circle({
                radius: 2.2,
                fill: new fabric.Color(`${x}`).setAlpha(0.5).toRgba(),
                left: click_points.x,
                top: click_points.y,
                hasControls: false,
                hasBorders: false,
                originX: 'center',
                originY: 'center',
                stroke: 'black'
            });
            canvas.add(circle);
        }
    };

    var check_points_zone;
    var zone_make = false;

    document.addEventListener('keydown', (event) => {
        if(event.key == 'Shift'){
            var warningZone = new fabric.Polygon(
            all_points,
            {
                fill: new fabric.Color(`${x}`).setAlpha(0.5).toRgba(),
                stroke: 'black',
                selectable: false,
                objectCaching: false
            });

            canvas.add(warningZone);
            check_points_zone = all_points;
            if(check_points_zone != 0) {
                zone_make = true;
            }
            all_points = [];
       };
    }, false);

    var persons = function(id) {
        var display = document.getElementById(id.replace('#', '')).style.display;
        if(display=='none'){
              document.getElementById(id.replace('#', '')).style.display='block';
        }

        document.addEventListener('mouseup', function(e) {
            var container = document.getElementById(id.replace('#', ''));
            if (!container.contains(e.target)) {
                document.getElementById("#optionsZone").disabled = false;
                container.style.display = 'none';
            }
        });
    };

    var edit_zone = function(id) {
        var display = document.getElementById(id.replace('#', '')).style.display;
        if(display=='none'){
              document.getElementById(id.replace('#', '')).style.display='block';
              makeZone();
        }
        else{
            document.getElementById(id.replace('#', '')).style.display='none';
            finishMake();
        }
    };

    var coordinates = [
        { left: 400, top: 200 }, { left: 370, top: 170 },
        { left: 300, top: 200 }, { left: 280, top: 170 },
        { left: 250, top: 200 }, { left: 220, top: 170 },
        { left: 200, top: 200 }, { left: 200, top: 180 },
        { left: 200, top: 160 }, { left: 200, top: 140 },
        { left: 180, top: 100 }, { left: 170, top: 170 },
        { left: 170, top: 150 }, { left: 170, top: 130 },
        { left: 170, top: 110 }, { left: 150, top: 70 },
        { left: 170, top: 50 }, { left: 160, top: 40 },
        { left: 140, top: 20 }, { left: 130, top: 20 },
        { left: 400, top: 200 }, { left: 370, top: 170 },
        { left: 300, top: 200 }, { left: 280, top: 170 },
        { left: 250, top: 200 }, { left: 220, top: 170 },
        { left: 200, top: 200 }, { left: 200, top: 180 },
        { left: 200, top: 160 }, { left: 200, top: 140 },
        { left: 180, top: 100 }, { left: 170, top: 170 },
        { left: 170, top: 150 }, { left: 170, top: 130 },
        { left: 170, top: 110 }, { left: 150, top: 70 },
        { left: 170, top: 110 }, { left: 150, top: 70 },
        { left: 170, top: 50 }, { left: 160, top: 40 },
    ];

    var i = 0;

    var move = function() {
        marker.set({ left: coordinates[i].left, top: coordinates[i].top });
        textGroup_marker.set({ left: coordinates[i].left + 30 * 0.5, top: coordinates[i].top - 20 * 0.5 });
        canvas.renderAll();
        if(zone_make){
            //check_inside_zone(check_points_zone, coordinates[i].left, coordinates[i].top);
        }
        i++;
        if( i < coordinates.length ){
            setTimeout( move, 1000 );
        }
    };

    //move();

    function correct_move(left_x,top_y)    
        {
                        marker.set({ left: left_x, top: top_y });
                        textGroup_marker.set({ left: left_x + 30 * 0.5, top: top_y - 20 * 0.5 });
                        canvas.renderAll();
                        check_inside_zone(left_x, top_y)
        
        }


    var check_inside_zone = function( x, y) {
        var canvas=document.getElementById('canvas');
        var ctx = canvas.getContext('2d');
        imgData=ctx.getImageData(x-10,y-10,1+10,1+10);
        red=imgData.data[0];
        green=imgData.data[1];
        blue=imgData.data[2];
        alpha=imgData.data[3];
        console.log(red)
        console.log(green)
        console.log(blue)
        console.log(alpha)
        var inside = false; 
        for (var i=0; i<imgData.data.length; i+=4)
        {
            if (imgData.data[i]<255){
                //inside = true;
                //correct_move(x-1,y-1)
                break
            }
        
        }
            if (inside) {
                imgData.data[i]=255;
                imgData.data[i+1]=0;
                imgData.data[i+2]=0;
                imgData.data[i+3]=255;

                swal.fire({
                  icon: 'warning',
                  title: 'Работник зашел в опасную зону',
                  toast: true,
                  position: 'top-end',
                  showConfirmButton: false,
                  timer: 1000
                })
        }
        /*for (var i=0; i<imgData.data.length; i+=4)
         {
                imgData.data[i]=255-imgData.data[i];
                imgData.data[i+1]=255-imgData.data[i+1];
                imgData.data[i+2]=255-imgData.data[i+2];
                imgData.data[i+3]=255;
          }*/

        /*var inside = false;
        for (var i = 0, j = pick_zone.length - 1; i < pick_zone.length; j = i++) {
            var xi = pick_zone[i].x, yi = pick_zone[i].y;
            var xj = pick_zone[j].x, yj = pick_zone[j].y;

            var inter = ((yi > y) != (yj > y))
                && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);

            if (inter) {
                swal.fire({
                  icon: 'warning',
                  title: 'Работник зашел в опасную зону',
                  toast: true,
                  position: 'top-end',
                  showConfirmButton: false,
                  timer: 1000
                })
            }
        }*/
    };


	function getTag()
		{
		cmd = 'refresh';
        $.ajax({
            type: 'POST', // метод отправки
            url: window.location.pathname+'gettag/', // путь к обработчику
            data: {
                "cmd": cmd
            },
            // dataType: 'text',
			success: function (data) {
                for (index = data.length - 1; index >= 0; --index) {
                    left_x = data[index].x*(1014/42)
                     top_y = (829 - data[index].y*(1014/42))
                    console.log(data[index].y*(867/42))
                    console.log(left_x+":"+top_y)
                    addMarker({x: data[index].x*(1014/42), y:(829 - data[index].y*(1014/42)), name: data[index].name, color: '#006400', skin: 'm 11,-19.124715 c -8.2234742,0 -14.8981027,-6.676138 -14.8981027,-14.9016 0,-5.633585 3.35732837,-10.582599 6.3104192,-14.933175 C 4.5507896,-52.109948 9.1631953,-59.34619 11,-61.92345 c 1.733396,2.518329 6.760904,9.975806 8.874266,13.22971 3.050966,4.697513 6.023837,8.647788 6.023837,14.667425 0,8.225462 -6.674629,14.9016 -14.898103,14.9016 z m 0,-9.996913 c 2.703016,0 4.903568,-2.201022 4.903568,-4.904687 0,-2.703664 -2.200552,-4.873493 -4.903568,-4.873493 -2.7030165,0 -4.903568,2.169829 -4.903568,4.873493 0,2.703665 2.2005515,4.904687 4.903568,4.904687z'});
                }
            },
            error: function (dataerr) {
                 console.log('Ошибка выполнение команды :'+dataerr)
            }
        });
		}
		function show()
		{
		cmd = 'refresh';
        $.ajax({
            type: 'POST', // метод отправки
            url: window.location.pathname+'ajax/', // путь к обработчику
            data: {
                "cmd": cmd
            },
            // dataType: 'text',
			success: function (data) {
                for (index = data.length - 1; index >= 0; --index) {
                    
                        left_x = data[index].x*(1014/42)
                        top_y = (829 - data[index].y*(1014/42))
                        marker.set({ left: left_x, top: top_y });
                        textGroup_marker.set({ left: left_x + 30 * 0.5, top: top_y - 20 * 0.5 });
                        canvas.renderAll();
                        //marker.set({ left: left_x, top: top_y });
                        //textGroup_marker.set({ left: left_x + 30 * 0.5, top: top_y - 20 * 0.5 });
                        //textGroup_marker.set({ left: left_x , top: top_y});
                        //canvas.renderAll();
                        //correct_move(left_x,top_y)
                        //check_inside_zone(left_x, top_y)

                     }
            },
            error: function (dataerr) {
                 console.log('Ошибка выполнение команды :'+dataerr)
            }
        });
		}

		$(document).ready(function(){
			getTag();
			setInterval('show()',1000);
            //setInterval('move()',1000);
		});

        
    </script>
    {% endblock script_footer %}
