{% extends "subsystem_base.html" %}
{% load static %}
{% load mysettings %}


{% block header_link %}
<link type="text/css" rel="stylesheet" href="{% static '/css/speedometer.css' %}?ver={% settings_value 'APP_VER' %}">
{% endblock header_link %}

 {% block info_title %}
    <h5>Система контроля пожарным водоснабжением<h5>  
 {% endblock info_title %}

{% block content %}
<section class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <p id="id_time"></p>
        </div>
    </div><!-- /.container-fluid -->
</section>

<section class="content">
    <div class="container-fluid">
            <div class="card card-primary card-outline card-tabs">
              <div class="card-header p-0 pt-1 border-bottom-0">
              </div>
              <div class="card-body">
                <div class="tab-content" id="custom-tabs-three-tabContent">
        

                  <div class="tab-pane fade active show" id="custom-tabs-three-home" role="tabpanel" aria-labelledby="custom-tabs-three-home-tab">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="row">
                                    {% for sensor in m_sensor %}
                                    <div class="col-6 col-md-3 text-center">
                                        <div style="display:inline;width:90px;height:90px;">
                                            <canvas id="{{sensor.sensor.id}}_value_canvas" class="gauge-speed" style="margin-top:40px;" data-type="radial-gauge" data-width="170"
                                                    data-glow="false" data-height="170" data-units="{{sensor.unit}}" data-title="{{sensor.sensor.id}}" data-min-value="0.0"
                                                    data-max-value="{{sensor.str_critical_value}}" data-major-ticks="{{sensor.scale}}" data-minor-ticks="10" data-value="{{sensor.str_value}}"
                                                    data-stroke-ticks="false" data-highlights='[{ "from": {{sensor.norm_value_from}}, "to": {{sensor.norm_value_to}}, "color": "#4caf50" },
                                                         { "from": {{sensor.danger_value_from}}, "to":{{sensor.danger_value_to}} , "color": "#ff9800" },{ "from": {{sensor.critical_value_from}}, "to": {{sensor.critical_value_to}}, "color": "#f44336" }]'
                                                    data-color-needle-start="rgba(240, 128, 128, 1)" data-color-needle-end="rgba(255, 160, 122, .9)"
                                                    data-value-box="true" data-animation-rule="linear" data-animation-duration="100"
                                                    data-needle-shadow="false"></canvas>
                                        </div>

                                        <div class="knob-label"><a href="sensor/?id={{sensor.sensor.id}}">{{sensor.sensor}}</a></div>
                                    </div>
                                    <!--<div class="col-6 col-md-3 text-center">
                                        <div style="display:inline;width:90px;height:90px;">
                                            <canvas id="{{sensor.sensor.id}}_valuecanvas" class="barrel" width="800" height="500" data-value="{{sensor.str_value}}"></canvas>
                                        </div>
                                        <div class="knob-label"><a href="sensor/?id={{sensor.sensor.id}}">{{sensor.sensor}}</a></div>
                                    </div>-->
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Показания датчиков</h3>
                                </div>
                                <!-- /.card-header -->
                                <div class="card-body p-0">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th style="width: 10px">id</th>
                                                <th>Датчик</th>
                                                <th style="width: 40px">Показание</th>
                                                <th style="width: 40px">МДЗ</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for sensor in m_sensor %}
                                            <tr>
                                                <td>{{sensor.sensor.id}}</td>
                                                <td id="{{sensor.sensor.id}}_pecent">
                                                    <div class="progress-group">
                                                      <a href="sensor/?id={{sensor.sensor.id}}">{{sensor.sensor}}</a>
                                                      <span class="float-right"><b>{{sensor.value}}</b>/{{sensor.max_value}}  {{sensor.unit}}</span>
                                                      <div class="progress progress-sm">
                                                        <div class="progress-bar {{sensor.color}}" style="width: {{sensor.str_value}}%"></div>
                                                      </div>
                                                    </div>
                                                </td>
                                                <td id="{{sensor.sensor.id}}_value"><span class="badge {{sensor.color}}">{{sensor.value}} {{sensor.unit}}</span></td>
                                                <td><span class="badge ">{{sensor.danger_value_to}} {{sensor.unit}}</span></td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>

                                </div>
                            </div>
                            <!-- /.row -->
                        </div><!-- /.container-fluid -->
                    </div>                  
                              </div>
                </div>
              </div>
              <!-- /.card -->
            </div>
    </div>
</section>


{% endblock %}

{% block script_footer %}
<script src="{% static 'js/gauge.min.js' %}?ver={% settings_value 'APP_VER' %}"></script>
<script src="{% static 'js/speedometer.js' %}?ver={% settings_value 'APP_VER' %}"></script>
<script src="{% static 'js/fabric.min.js' %}?ver={% settings_value 'APP_VER' %}"></script>
<script src="{% static 'js/barrel.js' %}?ver={% settings_value 'APP_VER' %}"></script>
<script>
		function show()
		{
		cmd = 'refresh';
        $.ajax({
            type: 'POST', // метод отправки
            url: window.location.pathname+'ajax/', // путь к обработчику
            data: {
                "cmd": cmd
            },
            // dataType: 'text',
			success: function (data) {
                for (index = data.length - 1; index >= 0; --index) {
					//str_pecent = "<div class='progress progress-xs progress-striped active'><div class='progress-bar " + data[index].color + " 'style=width:" + Math.floor(data[index].pecent_value) + "%></div></div>";
					//$("#" + data[index].sensor_id + "_pecent").html(str_pecent)

					str_value = "<span class='badge " + data[index].color + "'>" + data[index].value + " " + data[index].unit + "</span>";
					$("#" + data[index].sensor_id + "_value").html(str_value)
                    var seconds = new Date().getTime() / 1000;
                    //$("#id_time").html(seconds)
					$("#" + data[index].sensor_id + "_value_canvas").attr('data-value', data[index].value)
                }
            },
            error: function (dataerr) {
                 console.log('Ошибка выполнение команды :'+dataerr)
            }
        });
		}

		$(document).ready(function(){
			show();
			setInterval('show()', 1000);
		});

/*

  var canvas = new fabric.Canvas('1_valuecanvas', {
    selection: false,
    scale: 1,
    moveCursor: 'default',
    hoverCursor: 'default'
  });

  fabric.Object.prototype.selectable = false;
 // БОЧКА №1 //
  var water_up_tanker_1 = new fabric.Circle({
    left: 150,
    top: 100,
    radius: 100,
    scaleY: 0.25,
    originX: 'center',
    originY: 'center',
    fill: '#9DCDFF',
    stroke: '#9DCDFF',
    strokeWidth: 2
  });
  var water_mid_tanker_1 = new fabric.Rect({
    left: 150,
    top: 325,
    width: 200,
    height: 150,
    fill: '#9DCDFF',
    stroke: '#9DCDFF',
    strokeWidth: 2,
    originX: 'center',
    originY: 'center',

  });
  canvas.add(water_mid_tanker_1, water_up_tanker_1);

// основная бочка #1//
  var circle_tanker_1_1 = new fabric.Circle({
    left: 150,
    top: 100,
    radius: 100,
    fill: 'black',
    scaleY: 0.25,
    originX: 'center',
    originY: 'center'
  });
  var line_tanker_1_1 = new fabric.Line([248, 100, 249, 400], {
    stroke: 'black',
    strokeWidth: 2
  });
  var line_tanker_1_2 = new fabric.Line([50, 100, 49, 400], {
    stroke: 'black',
    strokeWidth: 2
  });
  var circle_tanker_1_2 = new fabric.Circle({
    left: 150,
    top: 400,
    radius: 100,
    scaleY: 0.40,
    originX: 'center',
    originY: 'center',
    startAngle: 0,
    endAngle: 180,
    fill: 'white',
    stroke: 'black',
    strokeWidth: 2
  });
  canvas.add(circle_tanker_1_1, line_tanker_1_1, line_tanker_1_2, circle_tanker_1_2);
// основная бочка //

  var water_down_tanker_1 = new fabric.Circle({
    left: 150,
    top: 400,
    radius: 98,
    scaleY: 0.40,
    originX: 'center',
    originY: 'center',
    fill: '#9DCDFF',
    stroke: '#9DCDFF',
    strokeWidth: 2
  });
  canvas.add(water_down_tanker_1);

  var water_line_tanker_1 = new fabric.Circle({
    left: 150,
    top: 200,
    radius: 100,
    scaleY: 0.25,
    originX: 'center',
    originY: 'center',
    startAngle: 0,
    endAngle: 180,
    fill: '#9DCDFF',
    stroke: 'black',
    strokeWidth: 2
  });
  canvas.add(water_line_tanker_1);

  var percent_tanker_1 = 5;
  var new_height_water_tanker_1 = water_down_tanker_1.top - (percent_tanker_1 * 3);
  var new_center_water_tanker_1 = water_down_tanker_1.top - (water_down_tanker_1.top - new_height_water_tanker_1)/2;
  var new_level_water_tanker_1 = water_down_tanker_1.top - new_height_water_tanker_1;

  console.log(new_height_water_tanker_1, new_center_water_tanker_1);

  water_up_tanker_1.set({
    top: new_height_water_tanker_1
  });

  water_mid_tanker_1.set({
    top: new_center_water_tanker_1,
    height: new_level_water_tanker_1
  });

  water_line_tanker_1.set({
    top: new_height_water_tanker_1 + 1
  });

  var text_level_tanker_1 = new fabric.Text(percent_tanker_1.toString(), { left: 130, top: 250, originX: 'center', originY: 'center' });
  var text_percent_tanker_1 = new fabric.Text('%', { left: percent_tanker_1.toString().length + 180, top: 250, originX: 'center', originY: 'center' });
  canvas.add(text_level_tanker_1, text_percent_tanker_1);

*/
  //canvas.renderAll();


</script>
{% endblock script_footer %}
